<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analyzer API</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: #f4f7f9;
            color: #333;
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .endpoint {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .endpoint h3 {
            margin-top: 0;
            color: #34495e;
            font-size: 1.2rem;
        }
        code {
            background: #e9ecef;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
        }
        input, select, button {
            padding: 10px 12px;
            margin-right: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #2980b9;
        }
        pre {
            background: #2c3e50;
            color: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Stock Analyzer API Interface</h1>

    <!-- 5Paisa Authentication -->
    <div class="endpoint">
        <h3>5Paisa OAuth Login</h3>
        <p><strong>Step 1:</strong> Click the button to get your unique login URL.</p>
        <button onclick="fetchApiData('getLoginUrl', 'link')">Get Login URL</button>
        <pre id="getLoginUrlResult">Login URL will appear here.</pre>
        <hr>
        <p><strong>Step 2:</strong> After logging in, copy the <code>RequestToken</code> from the browser's address bar and paste it below.</p>
        <input type="text" id="requestTokenInput" placeholder="Paste RequestToken here" style="width: 300px;">
        <button onclick="submitRequestToken()">Submit Token</button>
        <pre id="submitTokenResult"></pre>
    </div>

    <!-- BTST Recommendations -->
    <div class="endpoint">
        <h3>BTST Recommendations</h3>
        <p><code>GET /api/v1/analysis/btst/recommendations</code></p>
        <input type="text" id="btstRecDate" placeholder="Date (YYYY-MM-DD)">
        <select id="btstRecType">
            <option value="BUY">BUY</option>
            <option value="HOLD">HOLD</option>
            <option value="AVOID">AVOID</option>
        </select>
        <button onclick="fetchApiData('btstRec')">Fetch</button>
        <pre id="btstRecResult"></pre>
    </div>
    
    <!-- Run On-Demand Analysis -->
    <div class="endpoint">
        <h3>Run On-Demand BTST Analysis</h3>
        <p><code>GET /api/v1/analysis/btst/run</code></p>
        <input type="text" id="btstRunDate" placeholder="Date (YYYY-MM-DD)">
        <button onclick="fetchApiData('btstRun')">Run</button>
        <pre id="btstRunResult"></pre>
    </div>

    <!-- Detailed BTST Analysis -->
    <div class="endpoint">
        <h3>Detailed BTST Analysis</h3>
        <p><code>GET /api/v1/analysis/btst/detailed/{symbol}</code></p>
        <input type="text" id="btstDetailedSymbol" placeholder="Symbol (e.g., TCS)">
        <input type="text" id="btstDetailedDate" placeholder="Date (YYYY-MM-DD)">
        <button onclick="fetchApiData('btstDetailed')">Fetch</button>
        <pre id="btstDetailedResult"></pre>
    </div>

    <!-- All Indicators (JSON) -->
    <div class="endpoint">
        <h3>All Indicators (JSON)</h3>
        <p><code>GET /api/v1/analysis/indicators/all/json</code></p>
        <input type="text" id="allIndicatorsJsonDate" placeholder="Date (YYYY-MM-DD)">
        <button onclick="fetchApiData('allIndicatorsJson')">Fetch JSON</button>
        <pre id="allIndicatorsJsonResult"></pre>
    </div>

    <!-- All Indicators (CSV) -->
    <div class="endpoint">
        <h3>All Indicators (CSV)</h3>
        <p><code>GET /api/v1/analysis/indicators/all</code></p>
        <input type="text" id="allIndicatorsCsvDate" placeholder="Date (YYYY-MM-DD)">
        <button onclick="fetchApiData('allIndicatorsCsv', 'csv')">Download CSV</button>
        <pre id="allIndicatorsCsvResult">Click the button to download the CSV file.</pre>
    </div>

    <!-- Single Stock Indicator -->
    <div class="endpoint">
        <h3>Enriched Indicator for Symbol</h3>
        <p><code>GET /api/v1/analysis/indicators/{symbol}</code></p>
        <input type="text" id="singleIndicatorSymbol" placeholder="Symbol (e.g., TCS)">
        <input type="text" id="singleIndicatorDate" placeholder="Date (YYYY-MM-DD)">
        <button onclick="fetchApiData('singleIndicator')">Fetch</button>
        <pre id="singleIndicatorResult"></pre>
    </div>

    <!-- Export Indicators to File -->
    <div class="endpoint">
        <h3>Export All Indicators to File</h3>
        <p><code>POST /api/v1/analysis/indicators/export</code></p>
        <input type="text" id="exportIndicatorsDate" placeholder="Date (YYYY-MM-DD)">
        <button onclick="postApiRequest('exportIndicators')">Export to GDrive Synced Folder</button>
        <pre id="exportIndicatorsResult"></pre>
    </div>

    <!-- Export Indicators to CSV File -->
    <div class="endpoint">
        <h3>Export All Indicators to CSV File</h3>
        <p><code>POST /api/v1/analysis/indicators/export-csv</code></p>
        <input type="text" id="exportIndicatorsCsvDate" placeholder="Date (YYYY-MM-DD)">
        <button onclick="postApiRequest('exportIndicatorsCsv')">Export CSV to GDrive Synced Folder</button>
        <pre id="exportIndicatorsCsvResult"></pre>
    </div>

</div>

<script>
    async function fetchApiData(endpointId, type = 'json') {
        const resultEl = document.getElementById(endpointId + 'Result');
        resultEl.textContent = 'Loading...';

        let url = '';
        switch (endpointId) {
            case 'btstRec':
                const recDate = document.getElementById('btstRecDate').value;
                const recType = document.getElementById('btstRecType').value;
                url = `/api/v1/analysis/btst/recommendations?recommendation=${recType}`;
                if (recDate) url += `&date=${recDate}`;
                break;
            case 'btstRun':
                const runDate = document.getElementById('btstRunDate').value;
                url = `/api/v1/analysis/btst/run`;
                if (runDate) url += `?date=${runDate}`;
                break;
            case 'btstDetailed':
                const detailedSymbol = document.getElementById('btstDetailedSymbol').value.toUpperCase();
                const detailedDate = document.getElementById('btstDetailedDate').value;
                if (!detailedSymbol) {
                    resultEl.textContent = 'Error: Symbol is required.';
                    return;
                }
                url = `/api/v1/analysis/btst/detailed/${detailedSymbol}`;
                if (detailedDate) url += `?date=${detailedDate}`;
                break;
            case 'allIndicatorsJson':
                const jsonDate = document.getElementById('allIndicatorsJsonDate').value;
                url = `/api/v1/analysis/indicators/all/json`;
                if (jsonDate) url += `?date=${jsonDate}`;
                break;
            case 'allIndicatorsCsv':
                const csvDate = document.getElementById('allIndicatorsCsvDate').value;
                url = `/api/v1/analysis/indicators/all`;
                if (csvDate) url += `?date=${csvDate}`;
                break;
            case 'singleIndicator':
                const singleSymbol = document.getElementById('singleIndicatorSymbol').value.toUpperCase();
                const singleDate = document.getElementById('singleIndicatorDate').value;
                if (!singleSymbol) {
                    resultEl.textContent = 'Error: Symbol is required.';
                    return;
                }
                url = `/api/v1/analysis/indicators/${singleSymbol}`;
                if (singleDate) url += `?date=${singleDate}`;
                break;
            case 'getLoginUrl':
                url = '/api/v1/auth/5paisa/login-url';
                break;
        }

        try {
            const response = await fetch(url);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! Status: ${response.status} - ${errorText}`);
            }

            if (type === 'json') {
                const data = await response.json();
                resultEl.textContent = JSON.stringify(data, null, 2);
            } else if (type === 'csv') {
                const blob = await response.blob();
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = 'indicators.csv';
                link.click();
                resultEl.textContent = 'Download complete.';
            } else if (type === 'link') {
                const url = await response.text();
                resultEl.innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
            }

        } catch (error) {
            resultEl.textContent = `Error: ${error.message}`;
            console.error('Fetch error:', error);
        }
    }

    async function postApiRequest(endpointId) {
        const resultEl = document.getElementById(endpointId + 'Result');
        resultEl.textContent = 'Processing...';

        let url = '';
        switch (endpointId) {
            case 'exportIndicators':
                const exportDate = document.getElementById('exportIndicatorsDate').value;
                url = `/api/v1/analysis/indicators/export`;
                if (exportDate) url += `?date=${exportDate}`;
                break;
            case 'exportIndicatorsCsv':
                const exportCsvDate = document.getElementById('exportIndicatorsCsvDate').value;
                url = `/api/v1/analysis/indicators/export-csv`;
                if (exportCsvDate) url += `?date=${exportCsvDate}`;
                break;
        }

        try {
            const response = await fetch(url, {
                method: 'POST',
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! Status: ${response.status} - ${errorText}`);
            }

            const successText = await response.text();
            resultEl.textContent = successText;

        } catch (error) {
            resultEl.textContent = `Error: ${error.message}`;
            console.error('Fetch error:', error);
        }
    }

    async function submitRequestToken() {
        const resultEl = document.getElementById('submitTokenResult');
        const tokenInput = document.getElementById('requestTokenInput');
        const token = tokenInput.value.trim();

        if (!token) {
            resultEl.textContent = 'Error: Request Token cannot be empty.';
            return;
        }

        resultEl.textContent = 'Processing...';

        try {
            const response = await fetch('/api/v1/auth/5paisa/submit-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain'
                },
                body: token
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! Status: ${response.status} - ${errorText}`);
            }

            const successText = await response.text();
            resultEl.textContent = successText;
            tokenInput.value = ''; // Clear input on success

        } catch (error) {
            resultEl.textContent = `Error: ${error.message}`;
            console.error('Submit token error:', error);
        }
    }
</script>

</body>
</html>

